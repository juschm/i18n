#!/bin/bash
set -e -o pipefail

NUM_PARALLEL_PROCESSES=6

TYPESCRIPT_TO_NODEJS=(./node_modules/.bin/tsc \
  --noImplicitAny \
  --noEmitOnError \
  --target ES5 \
  --module commonjs \
  --declaration \
  --sourceMap \
  --noLib \
  ./node_modules/typescript/bin/lib.es6.d.ts \
  ./typings/node/node.d.ts \
  )

cd $(git rev-parse --show-toplevel)

# Transpile files individually.
find lib web -name '*.ts' -a '!' -name '*.d.ts' -print0 | xargs -0 -n 1 -P $NUM_PARALLEL_PROCESSES -t "${TYPESCRIPT_TO_NODEJS[@]}"

# Bundle files for browser.
# TODO: Source maps are broken.  We need to combine them together (use sorcery?)
./node_modules/.bin/cjsc web/index.js --source-map='*.map' -o web/bundle.js --config web/cjsc_config.json
